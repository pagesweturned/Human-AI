<!-- mturk-a3-2.html — Tweets → Cyberbullying Category (single-select with optional AI hint) -->
<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<crowd-form answer-format="flatten-objects">
  <section style="max-width:900px;margin:16px auto;font:16px/1.5 system-ui;">
    <h2 style="margin:0 0 8px;">Label the Category of Cyberbullying (Tweets)</h2>

    <details open style="margin:8px 0 16px;">
      <summary><b>Instructions</b></summary>
      <ul style="margin:8px 0 0 18px;padding:0;">
        <li>For each tweet, select the <b>single best</b> category.</li>
        <li>If the <b>Show AI hint</b> button is present, you may reveal it. The AI can be wrong — use your judgment.</li>
      </ul>
      <p style="margin-top:8px;"><i>Answer options</i>:
        <br>a. Age
        <br>b. Ethnicity
        <br>c. Gender
        <br>d. Religion
        <br>e. Other cyberbullying
        <br>f. Not cyberbullying
      </p>
    </details>

    <!-- MTURK STATUS / PREVIEW NOTICE -->
    <div id="mturkNotice" style="display:none;padding:10px;border:1px solid #e6b800;background:#fff8e1;border-radius:8px;margin:8px 0;">
      You’re previewing this HIT. Click <b>Accept</b> to start. (Inputs are disabled in preview.)
    </div>

    <div id="status" style="color:#555;margin:8px 0;">Loading…</div>
    <div id="quizArea"></div>

    <!-- Completion code shown once the task UI is ready -->
    <div id="completionBox" style="display:none;border-top:1px solid #eee;margin-top:16px;padding-top:16px;">
      <div style="font-weight:600;margin-bottom:6px;">Completion</div>
      <div style="color:#333;margin-bottom:6px;">Copy this code back into MTurk if asked, and press <b>Submit</b>:</div>
      <code id="completionCode" style="display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fafafa;"></code>
    </div>

    <!-- Hidden payload posted back to MTurk -->
    <input type="hidden" name="answers_json"      id="answers_json">
    <input type="hidden" name="trial_ids_json"    id="trial_ids_json">
    <input type="hidden" name="durations_ms_json" id="durations_ms_json">
    <input type="hidden" name="ai_shown_json"     id="ai_shown_json">
    <input type="hidden" name="rt_total_ms"       id="rt_total_ms">
    <input type="hidden" name="condition"         id="condition">
    <!-- NEW: identifiers + completion code -->
    <input type="hidden" name="worker_id"         id="worker_id">
    <input type="hidden" name="assignment_id"     id="assignment_id">
    <input type="hidden" name="hit_id"            id="hit_id">
    <input type="hidden" name="survey_code"       id="survey_code">
  </section>

  <script>
    // ======== CONFIG ========
    const DEFAULT_CSV = "https://raw.githubusercontent.com/pagesweturned/Human-AI/main/hai_dataset_quotes.csv";
    const qs          = new URLSearchParams(location.search);
    const CSV_URL     = qs.get("csv") || DEFAULT_CSV;

    const N_FIXED     = Number(qs.get("n") || 6);

    const condition   = (qs.get("condition") || "ai").toLowerCase();
    document.getElementById("condition").value = condition;

    // ======== READ MTURK IDS ========
    const workerId     = qs.get("workerId")     || "";
    const assignmentId = qs.get("assignmentId") || "";
    const hitId        = qs.get("hitId")        || "";

    // Save to hidden fields
    document.getElementById("worker_id").value     = workerId;
    document.getElementById("assignment_id").value = assignmentId;
    document.getElementById("hit_id").value        = hitId;

    // Detect Preview mode and disable inputs until accepted
    const inPreview = (assignmentId === "ASSIGNMENT_ID_NOT_AVAILABLE");
    function setInputsDisabled(disabled) {
      document.querySelectorAll("input, select, button").forEach(el => {
        // keep the platform's bottom Submit button enabled; it isn't part of this DOM anyway
        if (el.type !== "hidden") el.disabled = disabled;
      });
    }
    if (inPreview) {
      document.getElementById("mturkNotice").style.display = "block";
      setInputsDisabled(true);
    }

    // ======== CATEGORIES ========
    const CATEGORIES = [
      "Age",
      "Ethnicity",
      "Gender",
      "Religion",
      "Other cyberbullying",
      "Not cyberbullying"
    ];

    // ======== STATE ========
    let TRIALS=[], CURRENT=[];
    const answers   = {};   // trial_id -> chosen index (0..5)
    const durations = {};   // trial_id -> ms (time to first selection)
    const timers    = {};   // trial_id -> start time
    const aiShown   = {};   // trial_id -> 0/1
    const t0_total  = Date.now();

    // ======== UTIL ========
    function bucketConf(v){
      if (v == null || isNaN(v)) return "Unknown";
      if (v > 1 && v <= 100) v = v / 100; // percent → 0..1
      if (v < 0.33) return "Low";
      if (v < 0.66) return "Medium";
      return "High";
    }
    function uidFromIndex(i){ return "T" + (i + 1); }

    // Simple deterministic short code (based on worker+assignment+condition)
    function shortCode(s){
      let h=2166136261>>>0;
      for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; }
      return ("CYB-" + h.toString(36).toUpperCase()).slice(0,12);
    }

    // ======== DATA LOADING (fetch → Papa.parse for clearer errors) ========
    async function loadCsvTrials(){
      let res;
      try {
        res = await fetch(CSV_URL, { cache: "no-store", mode: "cors" });
      } catch (e) {
        throw new Error(`Network fetch failed: ${e && e.message ? e.message : e}`);
      }
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} while fetching ${CSV_URL}`);

      let text;
      try { text = await res.text(); }
      catch (e) { throw new Error(`Failed to read response body: ${e && e.message ? e.message : e}`); }

      const parsed = Papa.parse(text, { header:true, dynamicTyping:true, skipEmptyLines:true });
      if (parsed.errors && parsed.errors.length) {
        const first = parsed.errors[0];
        throw new Error(`CSV parse error (row ${first.row ?? "?"}): ${first.message || first.type}`);
      }

      const rows = Array.isArray(parsed.data) ? parsed.data : [];
      TRIALS = rows.map((r, idx)=>({
        trial_id:         uidFromIndex(idx),
        tweet:            (r.tweet ?? "").toString(),
        model_output:     r.model_output != null ? String(r.model_output) : "",
        model_confidence: r.model_confidence != null ? Number(r.model_confidence) : NaN
      })).filter(t => t.tweet.trim().length > 0);

      if (!TRIALS.length) {
        const keys = rows[0] ? Object.keys(rows[0]) : [];
        throw new Error(`Parsed 0 usable rows. First-row keys: ${keys.join(", ") || "(none)"}`);
      }
    }

    // ======== SAMPLE ========
    function sampleTrials(all, n, key){
      const seed = [...key].reduce((a,c)=>a+c.charCodeAt(0),0)+n;
      const rnd=(i)=>{let x=Math.imul(1779033703,(seed+i)|0);x^=x>>>16;x=Math.imul(2246822507,x);x^=x>>>13;x=Math.imul(3266489909,x);x^=x>>>16;return (x>>>0)/4294967296;}
      const arr=all.slice();
      for(let i=arr.length-1;i>0;i--){const j=Math.floor(rnd(i)*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
      return arr.slice(0, Math.min(n, arr.length));
    }

    // ======== UI RENDER ========
    function renderQuiz(trials){
      const area=document.getElementById("quizArea");
      area.innerHTML="";
      const showHintUI = (condition === "ai");

      if (!trials.length){
        document.getElementById("status").textContent = "Dataset is empty or missing required columns.";
        return;
      }

      trials.forEach((t, idx)=>{
        const card=document.createElement("div");
        card.style.cssText="border:1px solid #ddd;border-radius:10px;padding:16px;margin:16px 0;background:#fff;";

        const container = document.createElement("div");
        container.innerHTML = `
          <div style="font-weight:700;margin-bottom:6px;">Q${idx+1}</div>
          <blockquote id="tw_${t.trial_id}" style="margin:8px 0;padding:10px;border-left:4px solid #888;background:#fafafa;"></blockquote>
          ${ showHintUI ? `
            <div style="margin:8px 0;">
              <button type="button" class="hintBtn" data-id="${t.trial_id}"
                      style="padding:6px 10px;border:1px solid #ccc;border-radius:8px;cursor:pointer;">
                Show AI hint
              </button>
              <span id="hint_${t.trial_id}" style="margin-left:10px;color:#0a5a00;"></span>
            </div>` : `` }
        `;
        card.appendChild(container);

        card.querySelector(`#tw_${t.trial_id}`).textContent = t.tweet;

        const radiosWrap = document.createElement("div");
        radiosWrap.style.marginTop = "6px";
        radiosWrap.innerHTML = CATEGORIES.map((cat,i)=>`
          <label style="display:block;border:1px solid #eee;border-radius:8px;padding:10px;margin:8px 0;">
            <input type="radio" name="choice_${t.trial_id}" value="${i}" required> ${cat}
          </label>
        `).join("");
        card.appendChild(radiosWrap);

        area.appendChild(card);

        timers[t.trial_id]=Date.now();
        aiShown[t.trial_id]=0;

        card.addEventListener("change", ()=>{
          const sel=card.querySelector(`input[name="choice_${t.trial_id}"]:checked`);
          if (sel){
            if (durations[t.trial_id] == null){
              durations[t.trial_id] = Date.now()-timers[t.trial_id];
            }
            answers[t.trial_id] = Number(sel.value);
          }
        });

        if (showHintUI){
          const btn=card.querySelector(".hintBtn");
          btn?.addEventListener("click", ()=>{
            const confBucket = bucketConf(t.model_confidence);
            const hintEl = document.getElementById(`hint_${t.trial_id}`);
            hintEl.textContent = t.model_output
              ? `AI suggests: “${t.model_output}” (${confBucket} confidence)`
              : "No AI available.";
            aiShown[t.trial_id]=1;
            btn.disabled=true;
          });
        }
      });

      document.getElementById("status").textContent = `Loaded ${trials.length} tweets.`;

      // Generate and show a completion code as soon as UI is ready (hidden in Preview via disabled inputs)
      const code = shortCode([workerId, assignmentId, condition].join("|"));
      document.getElementById("survey_code").value = code;
      const codeEl = document.getElementById("completionCode");
      codeEl.textContent = code;
      document.getElementById("completionBox").style.display = "block";

      // Re-enable inputs if the worker accepted the HIT
      if (!inPreview) setInputsDisabled(false);
    }

    // ======== INIT ========
    (async function init(){
      const status = document.getElementById("status");
      try {
        await loadCsvTrials();
        const stableKey = (workerId || "anon") + "|" + (assignmentId || "assign");
        CURRENT = sampleTrials(TRIALS, N_FIXED, stableKey);
        renderQuiz(CURRENT);
      } catch (e) {
        console.error(e);
        status.textContent = "Failed to load dataset: " + (e && e.message ? e.message : e);
      }
    })();

    // ======== SUBMIT PACKAGING ========
    document.querySelector("crowd-form").addEventListener("submit", ()=>{
      document.getElementById("answers_json").value      = JSON.stringify(answers);
      document.getElementById("trial_ids_json").value    = JSON.stringify(CURRENT.map(t=>t.trial_id));
      document.getElementById("durations_ms_json").value = JSON.stringify(durations);
      document.getElementById("ai_shown_json").value     = JSON.stringify(aiShown);
      document.getElementById("rt_total_ms").value       = (Date.now()-t0_total);
      // ids + code already set
    });
  </script>
</crowd-form>
